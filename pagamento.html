<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pagamentos</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .extra-alert { background: #fff3e0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .valor-display { background:#e3f2fd; color:#0d47a1; padding:20px; text-align:center; border-radius:8px; border:1px solid #90caf9; margin-bottom:20px;}
        
        /* Estilo do Recibo (Invis√≠vel por padr√£o) */
        #recibo { display: none; border: 2px dashed #333; padding: 30px; margin-top: 20px; background: #fffff0; }
        #recibo h2 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><h2>üåä Pagamentos</h2></div>
        <nav id="menu-nav">
            <a href="index.html">Home</a>
            <a href="loja.html">Loja</a>
            <a href="orcamento.html">Or√ßamento</a>
            <a href="login.html" id="btn-login">Login</a>
        </nav>
    </header>
    <main style="max-width:600px; margin: 80px auto;">
        
        <div id="recibo" class="card">
            <h2>‚úÖ COMPROVANTE DE PAGAMENTO</h2>
            <p><strong>Empresa:</strong> LimpaPiscina Servi√ßos</p>
            <p><strong>Cliente:</strong> <span id="recibo-cliente">Nome</span></p>
            <p><strong>Valor Pago:</strong> <span id="recibo-valor">R$ 0,00</span></p>
            <p><strong>Data:</strong> <span id="recibo-data">00/00/0000</span></p>
            <p><strong>Descri√ß√£o:</strong> Mensalidade / Manuten√ß√£o de Piscina</p>
            <br>
            <p style="text-align:center; font-size:0.8rem;">Este documento comprova a quita√ß√£o do servi√ßo acima.</p>
            <br>
            <button onclick="window.print()" class="btn" style="width:100%; background:#333;">üñ®Ô∏è Imprimir Comprovante</button>
            <a href="index.html" class="btn" style="display:block; text-align:center; margin-top:10px; background:#ccc; color:#333;">Voltar ao In√≠cio</a>
        </div>

        <div id="conteudo-pagamento">
            <div id="area-extras" style="display:none;">
                <h3 style="color:#e65100;">‚ö†Ô∏è Pagamentos Pendentes</h3>
                <div id="lista-extras"></div>
            </div>

            <div id="area-pagamento" class="card" style="display:none; margin-top:30px;">
                <h2 style="text-align:center; color:var(--primary-blue);">Assinatura Mensal</h2>
                <div class="valor-display">
                    <p>VALOR CONTRATADO</p>
                    <h3 id="valor-mostra">R$ 0,00</h3>
                    <p id="desc-mostra" style="font-style:italic; font-size:0.9rem; margin-top:5px;">...</p>
                </div>
                <form id="form-assinatura">
                    <label>Cart√£o de Cr√©dito</label>
                    <input type="text" placeholder="0000 0000 0000 0000" required>
                    <div style="display:flex; gap:10px;">
                        <input type="text" placeholder="MM/AA" required>
                        <input type="text" placeholder="CVV" required>
                    </div>
                    <button type="submit" class="btn" style="width:100%">Pagar Mensalidade</button>
                </form>
            </div>

            <div id="msg-erro" class="card" style="display:none; text-align:center;">
                <h2 style="color:#d32f2f;">Sem contrato ativo</h2>
                <p>Aguarde a visita t√©cnica para defini√ß√£o de valores.</p>
            </div>
        </div>

    </main>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Menu Din√¢mico
        document.addEventListener('DOMContentLoaded', () => {
            const session = localStorage.getItem("@limpapiscina/session");
            if (session) {
                const user = JSON.parse(session);
                const nav = document.getElementById('menu-nav');
                const btnLogin = document.getElementById('btn-login');
                
                const linkPagamento = document.createElement('a');
                linkPagamento.href = "pagamento.html"; linkPagamento.innerText = "Pagamento";
                linkPagamento.style.borderBottom = "2px solid white";
                nav.insertBefore(linkPagamento, btnLogin);
                
                btnLogin.innerText = "Sair"; btnLogin.href = "#"; btnLogin.onclick = logout;
                
                carregarFinanceiro(user);
            } else {
                alert("Fa√ßa login."); window.location.href = "login.html";
            }
        });

        function carregarFinanceiro(user) {
            // Extras
            const extras = getMinhasExtras(user.email);
            if(extras.length > 0) {
                document.getElementById('area-extras').style.display = 'block';
                const lista = document.getElementById('lista-extras');
                lista.innerHTML = '';
                extras.forEach(item => {
                    lista.innerHTML += `
                        <div class="extra-alert">
                            <div><h4>${item.descricao}</h4><span>R$ ${parseFloat(item.valor).toFixed(2)}</span></div>
                            <button onclick="pagarItemExtra(${item.id})" class="btn" style="background:#e65100;">Pagar</button>
                        </div>`;
                });
            }

            // Mensal
            const plano = getMeuPlano(user.email);
            if (plano && plano.valor) {
                document.getElementById('area-pagamento').style.display = 'block';
                document.getElementById('valor-mostra').innerText = parseFloat(plano.valor).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('desc-mostra').innerText = plano.descricao;
            } else {
                document.getElementById('msg-erro').style.display = 'block';
            }
        }

        // Pagar Extra
        window.pagarItemExtra = function(id) {
            if(confirm("Pagar agora?")) {
                pagarExtra(id); alert("Pagamento avulso recebido!"); location.reload();
            }
        }

        // Pagar Mensalidade e GERAR RECIBO
        document.getElementById('form-assinatura').addEventListener('submit', (e)=>{ 
            e.preventDefault();
            
            const session = JSON.parse(localStorage.getItem("@limpapiscina/session"));
            const plano = getMeuPlano(session.email);

            // 1. Atualiza status no sistema (Admin ver√° "Pago")
            confirmarPagamentoMensal(session.email);

            // 2. Esconde formul√°rios
            document.getElementById('conteudo-pagamento').style.display = 'none';

            // 3. Preenche e mostra Recibo
            document.getElementById('recibo-cliente').innerText = session.nome;
            document.getElementById('recibo-valor').innerText = "R$ " + parseFloat(plano.valor).toFixed(2);
            document.getElementById('recibo-data').innerText = new Date().toLocaleString();
            document.getElementById('recibo').style.display = 'block';
        });
    </script>
    
    <a href="https://wa.me/5511999999999" class="whatsapp-float" target="_blank">üí¨</a>
</body>
</html>
